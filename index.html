<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Spyfall Game</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css"
      rel="stylesheet"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
    <link href="custom/custom.css" rel="stylesheet" type="text/css" />
    <script src="custom/lang.js"></script>
  </head>

  <body>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const backgrounds = [
          "gallary/picture/1.PNG",
          "gallary/picture/2.PNG",
          "gallary/picture/3.PNG",
          "gallary/picture/4.PNG",
          "gallary/picture/5.PNG",
          "gallary/picture/6.PNG",
          "gallary/picture/7.PNG",
          "gallary/picture/8.PNG",
          "gallary/picture/9.PNG",
          "gallary/picture/10.PNG",
          "gallary/picture/11.PNG",
          "gallary/picture/12.PNG",
          "gallary/picture/13.PNG",
          "gallary/picture/14.PNG",
          "gallary/picture/15.PNG",
          "gallary/picture/16.PNG",
          "gallary/picture/17.PNG",
          "gallary/picture/18.PNG",
        ];

        const selectedBg =
          backgrounds[Math.floor(Math.random() * backgrounds.length)];

        document.body.style.backgroundImage = `url('${selectedBg}')`;
      });
    </script>
    <style>
      body {
        background-size: cover;
        background-repeat: no-repeat;
        background-position: center center;
        transition: background-image 1s ease-in-out;
      }
      .button-settings-p {
        display: flex;
        flex-direction: column;
        width: 100%;
        min-width: 160px;
        align-items: center;
        justify-content: center;
        text-align: center;
        align-self: center;
      }
      .btn-top-set {
        margin-top: 30px !important;
        background-color: transparent;
        color: white;
        padding: 10px;
        border: 1px solid white;
        font-family: "AbdoMaster";
        font-weight: 400;
      }
      .ad-banner {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 60px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .ad-content {
        color: white;
        font-weight: bold;
        font-size: 16px;
        text-align: center;
      }
      .ad-text {
        animation: pulse 2s infinite;
      }
      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.7;
        }
      }
      @media (max-width: 768px) {
        .ad-banner {
          height: 50px;
        }
        .ad-content {
          font-size: 14px;
        }
      }
      body {
        padding-top: 70px;
      }
    </style>

    <div
      id="langSwitcherContainer"
      style="
        position: fixed;
        top: 10px;
        right: 20px;
        z-index: 2000;
        display: flex;
        align-items: center;
        gap: 8px;
      "
    >
      <span
        id="langSwitcherLabel"
        style="
          box-shadow: -4px -8px 0px rgb(0 0 0);
          font-weight: 600;
          color: #fff;
          background: #20bb58;
          padding: 6px 23px;
          font-size: 14px;
          box-shadow: -4px -3px 0px rgb(0, 2, 1);
          font-family: 'AbdoMaster';
        "
      ></span>
      <select
        id="langSwitcher"
        class="form-select form-select-sm"
        style="
          width: 120px;
          background: #fff;
          color: #20bb58;
          border: none;
          border-radius: 0 !important;
          font-weight: 600;
          text-align: center;
          box-shadow: -4px -3px 0px rgb(0, 2, 1);
          font-family: 'AbdoMaster';
        "
      >
        <option value="ar">العربية</option>
        <option value="en">English</option>
      </select>
    </div>

    <div class="ad-banner">
      <div
        class="ad-content"
        style="display: flex; align-items: center; gap: 12px"
      >
        <img
          class="ad-img"
          src=""
          alt="Ad Image"
          style="
            max-height: 48px;
            max-width: 80px;
            display: none;
            border-radius: 6px;
            background: #fff;
          "
        />
        <span class="ad-text"></span>
      </div>
    </div>

    <div class="container">
      <div class="header">
        <img src="gallary/name-12.png" class="img-fluid" alt="img" />
      </div>

      <div class="game-container">
        <div class="spy-icon"></div>

        <div id="newGameSection" class="text-center mb-4">
          <button id="newGameBtn" class="btn-action new-game-btn"></button>
          <input
            type="text"
            id="newGameInput"
            class="form-control form-control-custom d-none"
            placeholder=""
          />
        </div>

        <div id="joinGameSection" class="text-center button-settings-p">
          <button id="joinGameBtn" class="btn-action join-game-btn"></button>
          <input
            type="text"
            id="joinGameInput"
            class="form-control form-control-custom d-none"
            placeholder=""
          />
          <button
            id="clearNameBtn"
            class="btn btn-sm btn-outline-secondary mt-2 d-none btn-top-set"
          ></button>
        </div>

        <div class="character">
          <div class="character-head">
            <div class="character-eye eye-left"></div>
            <div class="character-eye eye-right"></div>
            <div class="character-mouth"></div>
          </div>
          <div class="character-body"></div>
        </div>
      </div>
    </div>

    <script>
      // Localization
      function updateLocalizedUI() {
        document.title = t("gameTitle");
        document.getElementById("newGameBtn").textContent = t("startGame");
        document.getElementById("joinGameBtn").textContent = t("joinGame");
        document.getElementById("clearNameBtn").textContent = t("clearName");
        document.getElementById("newGameInput").placeholder = t("enterName");
        document.getElementById("joinGameInput").placeholder =
          t("enterGameCode");
        const adText = document.querySelector(".ad-text");
        if (adText && currentAds.length === 0) {
          adText.textContent = t("adHere");
        }
      }

      document.addEventListener("DOMContentLoaded", function () {
        const langSwitcher = document.getElementById("langSwitcher");
        const langLabel = document.getElementById("langSwitcherLabel");
        const langLabelText = { en: "Language", ar: "اللغة" };

        function updateLangLabel() {
          const lang = localStorage.getItem("lang") || "ar";
          langLabel.textContent = langLabelText[lang] || langLabelText["en"];
        }

        database
          .ref("admin/settings/languageCondition")
          .once("value")
          .then((snapshot) => {
            const firebaseLang = snapshot.val();
            const selectedLang =
              firebaseLang || localStorage.getItem("lang") || "ar";
            langSwitcher.value = selectedLang;
            localStorage.setItem("lang", selectedLang);
            updateLangLabel();
            updateLocalizedUI();
          })
          .catch((error) => {
            console.error("Error loading language from Firebase:", error);
            const selectedLang = localStorage.getItem("lang") || "ar";
            langSwitcher.value = selectedLang;
            localStorage.setItem("lang", selectedLang);
            updateLangLabel();
            updateLocalizedUI();
          });

        langSwitcher.addEventListener("change", function () {
          const selectedLang = langSwitcher.value;
          localStorage.setItem("lang", selectedLang);
          database
            .ref("admin/settings/languageCondition")
            .set(selectedLang)
            .then(() => {
              updateLangLabel();
              updateLocalizedUI();
            })
            .catch((error) => {
              console.error("Error saving language to Firebase:", error);
              alert(
                t("languageSaveError") || "Failed to save language preference."
              );
            });
        });
      });

      // Firebase Configuration
      const firebaseConfig = {
        apiKey: "AIzaSyAXUdqcAfldO1YuxlKDWCh7EYo2nO4AMog",
        authDomain: "spyfall-fb59a.firebaseapp.com",
        projectId: "spyfall-fb59a",
        storageBucket: "spyfall-fb59a.firebasestorage.app",
        messagingSenderId: "125069847545",
        appId: "1:125069847545:web:faa43c6e58db9df7242b28",
        measurementId: "G-MFV3SETE0D",
        databaseURL: "https://spyfall-fb59a-default-rtdb.firebaseio.com",
      };
      firebase.initializeApp(firebaseConfig);
      const database = firebase.database();

      // Ad system
      let currentAds = [];
      let currentAdIndex = 0;

      function loadAdsFromFirebase() {
        database.ref("admin/ads").on("value", (snapshot) => {
          const adsData = snapshot.val() || {};
          currentAds = Object.values(adsData).filter(
            (ad) => ad.status === "active"
          );
          if (currentAds.length === 0) {
            currentAds = [{ title: "Default Ad", content: "", url: "" }];
          }
          initializeAdRotation();
        });
      }

      function initializeAdRotation() {
        if (currentAds.length > 0) {
          updateAdBanner();
          if (currentAds.length > 1) {
            setInterval(() => {
              currentAdIndex = (currentAdIndex + 1) % currentAds.length;
              updateAdBanner();
            }, 30000);
          }
        }
      }

      function updateAdBanner() {
        const adText = document.querySelector(".ad-text");
        const adImg = document.querySelector(".ad-img");
        if (currentAds.length > 0) {
          const currentAd = currentAds[currentAdIndex];
          adText.textContent = currentAd.content;
          if (currentAd.image && currentAd.image !== "") {
            adImg.src = currentAd.image;
            adImg.style.display = "inline-block";
          } else {
            adImg.style.display = "none";
            adImg.src = "";
          }
        } else if (adText) {
          adText.textContent = t("adHere");
          adImg.style.display = "none";
        }
      }

      loadAdsFromFirebase();

      // DOM Elements
      const newGameBtn = document.getElementById("newGameBtn");
      const joinGameBtn = document.getElementById("joinGameBtn");
      const newGameInput = document.getElementById("newGameInput");
      const joinGameInput = document.getElementById("joinGameInput");
      const clearNameBtn = document.getElementById("clearNameBtn");

      let newGameClicked = false;
      let joinGameClicked = false;

      // Fetch maxPlayers from Firebase
      async function getMaxPlayers() {
        try {
          const snapshot = await database
            .ref("admin/settings/maxplayers")
            .once("value");
          return snapshot.val() || 101; // Default to 101 if not set
        } catch (error) {
          console.error("Error fetching maxplayers:", error);
          return 101; // Fallback to 101
        }
      }

      // Game Code Generator
      function generateGameCode() {
        const chars = "0123456789";
        let code = "";
        for (let i = 0; i < 5; i++) {
          code += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return code;
      }

      // New Game Logic
      newGameBtn.addEventListener("click", async () => {
        if (!newGameClicked) {
          newGameClicked = true;
          newGameInput.classList.remove("d-none");
          newGameInput.focus();
          joinGameBtn.style.display = "none";
          joinGameInput.classList.add("d-none");
          return;
        }

        const name = newGameInput.value.trim();
        if (name === "") {
          alert(t("nameRequiredError") || "Please enter your name.");
          return;
        }
        localStorage.setItem("hostNameFor_", "host");
        localStorage.setItem("playerName", name);
        const gameCode = generateGameCode();
        localStorage.setItem("gameCode", gameCode);

        try {
          await database.ref("games/" + gameCode).set({
            host: name,
            players: { [name]: true },
            playerOrder: [name],
            createdAt: Date.now(),
          });
          window.location.href = `nextpage.html?code=${gameCode}`;
        } catch (err) {
          console.error("Error creating game:", err);
          alert(t("createGameError") || "Failed to create game.");
        }
      });

      // Join Game Logic
      joinGameBtn.addEventListener("click", async () => {
        if (!joinGameClicked) {
          joinGameClicked = true;
          joinGameInput.classList.remove("d-none");
          joinGameInput.focus();
          newGameBtn.style.display = "none";
          newGameInput.classList.add("d-none");
          if (localStorage.getItem("playerName")) {
            clearNameBtn.classList.remove("d-none");
          }
          return;
        }

        const code = joinGameInput.value.trim();
        if (code === "") {
          alert(t("codeRequiredError") || "Please enter the game code.");
          return;
        }

        let name = localStorage.getItem("playerName");
        if (!name) {
          name = prompt(t("enterNamePrompt") || "Enter your name:");
          if (!name || name.trim() === "") {
            alert(
              t("nameRequiredError") || "Name is required to join the game."
            );
            return;
          }
          name = name.trim();
        } else {
          const useSavedName = confirm(
            t("useSavedNamePrompt", { name }) ||
              `Use saved name "${name}"? Click Cancel to enter a new name.`
          );
          if (!useSavedName) {
            name = prompt(t("enterNamePrompt") || "Enter your name:");
            if (!name || name.trim() === "") {
              alert(
                t("nameRequiredError") || "Name is required to join the game."
              );
              return;
            }
            name = name.trim();
          }
        }

        localStorage.setItem("gameCode", code);

        try {
          const snapshot = await database.ref("games/" + code).once("value");
          if (!snapshot.exists()) {
            alert(
              t("gameNotFoundError") || "Game code not found. Please try again."
            );
            return;
          }

          const gameData = snapshot.val();
          const players = gameData.players || {};
          const maxPlayers = await getMaxPlayers();

          if (Object.keys(players).length >= maxPlayers) {
            alert(
              t("gameFullError") ||
                `This game is full with ${maxPlayers} players.`
            );
            return;
          }

          if (players[name]) {
            // Allow rejoining with the same name if it's the same player
            window.location.href = `nextpage.html?code=${code}`;
            return;
          }

          const result = await database.ref(`games/${code}/players`).update({
            [name]: true,
          });

          await database
            .ref(`games/${code}/playerOrder`)
            .transaction((order) => {
              if (!order) return [name];
              if (!order.includes(name)) return [...order, name];
              return order;
            });

          localStorage.setItem("playerName", name);
          window.location.href = `nextpage.html?code=${code}`;
        } catch (err) {
          console.error("Error joining game:", err);
          alert(t("joinGameError") || "Failed to join game. Please try again.");
        }
      });

      // Clear Name Button Logic
      clearNameBtn.addEventListener("click", () => {
        localStorage.removeItem("playerName");
        localStorage.removeItem("hostNameFor_");
        alert(
          t("nameCleared") ||
            "Saved name cleared. You can now enter a new name."
        );
        clearNameBtn.classList.add("d-none");
      });

      if (localStorage.getItem("playerName")) {
        clearNameBtn.classList.remove("d-none");
      }
    </script>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"
      crossorigin="anonymous"
    ></script>

 

    <button id="micBtn" style="
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 999;
    width: 60px;
    height: 60px;
    border-radius: 10px;
    background-color: #20BB58;
    color: white;
    border: 2px solid white;
    /* Sharp top-left shadow, no blur */
    box-shadow: -6px -6px 0 rgba(0,0,0,0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    cursor: pointer;
    transition: all 0.2s ease;
  ">
    <i id="micIcon" class="bi bi-mic-mute-fill"></i>
  </button>
  
  <button id="speakerBtn" style="
    position: fixed;
    bottom: 90px;
    right: 20px;
    z-index: 999;
    width: 60px;
    height: 60px;
    border-radius: 10px;
    background-color: #20BB58;
    color: white;
    border: 2px solid white;
    box-shadow: -6px -6px 0 rgba(0,0,0,0.8); /* sharp top-left shadow */
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    cursor: pointer;
    transition: all 0.2s ease;
  ">
    <i id="speakerIcon" class="bi bi-volume-up-fill"></i>
  </button>
  

<script src="voiceChat.js"></script>
  </body>
</html>
